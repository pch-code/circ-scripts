1. Run STARchip. 

2. Create a bed file of merged exonic coordinates and flanking introns based on the circRNA isoform coordinates (will use it to get exact GC and length for DESeq).
   2.1 MakeExonBedForMerging.pl -i {Main.gtf to create the *.exonsByGene.bed file}

Using a rat genome example. Convert the main gtf file into a bed file. 

perl MakeExonBedForMerging.pl -i Rattus_norvegicus.Rnor_6.0.96.gtf -o Rattus_norvegicus.Rnor_6.0.96.exonsByGene.bed

The output looks like this:
1	396700	396905	ENSRNOG00000046319:AABR07000046.1
1	397780	397788	ENSRNOG00000046319:AABR07000046.1
1	399062	399070	ENSRNOG00000046319:AABR07000046.1
1	399557	399827	ENSRNOG00000046319:AABR07000046.1
1	400256	401059	ENSRNOG00000046319:AABR07000046.1
1	401912	402136	ENSRNOG00000046319:AABR07000046.1
 

   2.2 Merge using bedops:

cut -f4 Rattus_norvegicus.Rnor_6.0.96.exonsByGene.bed | sort | uniq | awk -F'_' '{ system("grep "$1" Rattus_norvegicus.Rnor_6.0.96.exonsByGene.bed | bedops --merge - "); print $0; }' > Rattus_norvegicus.Rnor_6.0.96.MergedExonsByGene.txt

The output looks like this (coordinates for each exon followed by a line with gene ID and gene symbol):
2	230660664	230660669
2	230660675	230662084
ENSRNOG00000000001:AABR07013255.1
...

   2.3 Make merged CircRNA.bed file from  Rattus_norvegicus.Rnor_6.0.96.MergedExonsByGene.txt

   perl GetExonsAndFlankingIntronsRegionsPerAnnotatedCircRNA.pl -i Rattus_norvegicus.Rnor_6.0.96.MergedExonsByGene.txt -c circRNA.5reads.1ind.annotated -o circRNAExonicCoords.txt
   -i here is the output of step 2.2.
   
 The output looks like this:
chr10	101667886	101667980	ENSG00000107829:FBXW4:chr10:101667886:101676436
chr10	101672915	101673047	ENSG00000107829:FBXW4:chr10:101667886:101676436
chr10	101673488	101673673	ENSG00000107829:FBXW4:chr10:101667886:101676436

   
3. bedtools nuc -fi ~/Reference/Rat/Rattus_norvegicus.Rnor_6.0.dna.toplevel.fa -bed circRNAExonicCoords.txt > MergedIntervalsGC.txt
   echo -e "Gene\tgc\tlength" > CircRNA_GC_Len.txt && awk '{print $4"\t"$6"\t"$13}' MergedIntervalsGC.txt | grep "ENS" >> CircRNA_GC_Len.txt
   perl AddExonLengths_WeightedAvgGC_Annot.pl -i CircRNA_GC_Len.txt -o CollapsedCircRNA_GC_Len.txt # this will also create AnnotatedCircRNA_Counts.txt

The output contains circRNA coordinates, GC content, and feature length.
   
4. perl makeBed.pl -i AnnotatedCircRNA_Counts.txt -o circRNA.bed

The output contains circRNA coordinates:
10	16724062	16730140	Crebrf:ENSRNOG00000020769
10	51724607	51739115	Myocd:ENSRNOG00000003669
1	116642079	116660509	Ube3a:ENSRNOG00000015734
1	126573474	126583015	Tm2d3:ENSRNOG00000011290
...
 
5. Run RSEM with the --output-genome-bam and --sampling-for-bam parameters.  This will generate a genome-level BAM with each read mapped to a single location (${outfile}.genome.bam) 

for file in Alignments_transcriptome/{sample name}.Aligned.toTranscriptome.out.bam
do
   outfile=${file%%.Aligned.toTranscriptome.out.bam}
   outfile=${outfile##Alignments_transcriptome/}
  
  rsem-calculate-expression --output-genome-bam --sampling-for-bam -p 12 --alignments --paired-end --strandedness reverse Alignments_transcriptome/$outfile.Aligned.toTranscriptome.out.bam {rsem-reference} $outfile
done

6. Use the files created in steps 4 and 5 to generate circRNA coverage files
for file in *.genome.bam
do
  outfile=${file%%.genome.bam}
  bedtools coverage -a circRNA.bed -b $file > $outfile.cov.txt # syntax changed for versions >= 2.24.0. For previous versions: bedtools coverage -abam $file -b circRNA.bed  
done

7. Calculate median insert size for every sample. Copy all output to a subfolder. It will be used to estimate percentage of circRNA in the next step. 
Average median insert size is will be passed to EstCircCounts_FragCountNormByExonicLen.pl in step 8.
for file in *.genome.bam
do
  outfile=${file%%.genome.bam}
  java -jar picard.jar CollectInsertSizeMetrics I=$file O=$outfile.InsSize.txt H=$outfile.InsSize.pdf
done
 

8. Estimate counts and percentages of each circRNA isoform:
perl EstCircCounts_FragCountNormByExonicLen.pl -i circRNARegions_TotalRNACov -c AnnotatedCircRNA_Counts.txt -s circs5.1.investigate.consensus -m {directory with *.InsSize.txt files to extract average median insert sizes} -r {read length of PE reads} -o EstCircRNAProportions.txt 
-i is the directory with the Total coverages
-c created in step 2.3 (AnnotatedCircRNA_Counts.txt)
-m median insert size is calculated in step 7


9. Subtract the estimated circRNA counts from the total RNA counts:
perl SubtractTheCircCounts.pl -t {TotalRNA counts file}.OrigNames.txt -c EstCircRNAProportions.txt.circCounts.txt -o mRNACounts.txt
 
Note: The {TotalRNA counts file}.OrigNames.txt, contains total RNA counts (gene level read counts generated by RSEM, in which the first line is a header and the subsequent lines contain Ensembl Gene ID in the first column and read counts for each sample in the following columns).
The file can be prepared using: 
perl PrepareCountsForDESeq_FromRSEM.pl -i counts_file_list_in_Group1 -j counts_file_list_in_Group2 -o out_for_DESeq.txt  

